{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Root Stack for wraith, using wraithD wraith2 embedded containerd this stack calls all other stacks and outputs how to connect when complete",
    "Parameters": {
        "AvailabilityZone1": {
            "Description": "AWS Availability Zone One",
            "Type": "String",
            "Default": "eu-west-3a"
        },
        "AvailabilityZone2": {
            "Description": "AWS Availability Zone Two",
            "Type": "String",
            "Default": "eu-west-3b"
        },
        "AvailabilityZone3": {
            "Description": "AWS Availability Zone Three",
            "Type": "String",
            "Default": "eu-west-3c"
        },
        "VPCCIDR1": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for entire management control VPC.",
            "Default": "100.72.100.0/22",
            "Type": "String"
        },
        "PublicSubnetCIDR1": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block for the NAT GW parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the public subnet",
            "Default": "100.72.103.0/24",
            "Type": "String"
        },
        "PrivateSubnetCIDR1": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the private subnet AZ1",
            "Default": "100.72.100.0/24",
            "Type": "String"
        },
        "PrivateSubnetCIDR2": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the private subnet AZ2",
            "Default": "100.72.101.0/24",
            "Type": "String"
        },
        "PrivateSubnetCIDR3": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/16-28",
            "Description": "CIDR block for the private subnet AZ3",
            "Default": "100.72.102.0/24",
            "Type": "String"
        },
        "SiteName": {
            "Description": "Site Name",
            "Type": "String",
            "Default": "wraith"
        },
        "VPCDOMAIN": {
            "Description": "VCP domain type",
            "Type": "String",
            "Default": "default"
        },
        "WraithNodeInstanceType": {
            "Description": "wraith node Instance Type",
            "Type": "String",
            "Default": "m5.large"
        },
        "KeyName": {
            "Description": "SSH Key Name",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Default": "wraithkey"
        },
        "BastionInstanceType": {
            "Description": "Contrail Bastion Instance Type",
            "Type": "String",
            "Default": "m5.large"
        },
        "ContrailBastionPrivateSNGatewayIP": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
            "ConstraintDescription": "parameter must be in the form x.x.x.x",
            "Description": "Private Network Gateway IP used by Contrail Bastion to reach the other nodes",
            "Default": "100.72.100.1",
            "Type": "String"
        },
        "DeployContrailBastion": {
            "Description": "Wraith is fully automated, you do not need to connect except to debug. In which case set to true to deploy a bastion for ssh access",
            "Type": "String",
            "Default": "false"
        },
        "ContrailBastionAZ1PublicIP": {
            "Description": "Contrail Bastion public static IP",
            "Type": "String",
            "Default": "100.72.103.10"
        },
        "ContrailBastionAZ1PrivateIP": {
            "Description": "Contrail Bastion private static IP",
            "Type": "String",
            "Default": "100.72.100.10"
        },
        "WraithAZ1PrivateIP": {
            "Description": "wraith build node private static IP",
            "Type": "String",
            "Default": "100.72.100.11"
        },
        "UserLocation" : {
            "Description": "The IP address range that can be used for OAM access to CC and if running HA the load balancer, both on internet. Typically your laptop /32. If left blank we will add 0.0.0./0 and allow ssh from anywhere",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "18",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "Default": "0.0.0.0/0",
            "ConstraintDescription": "Put your Client IP here x.x.x.x/32, if you leave it blank then 0.0.0.0/0 will be populated and the internet will be able access your deployments UI and SSH"
        },
        "SiteName": {
            "Description": "Site Name",
            "Type": "String",
            "Default": "wraith"
        },
        "NMAPVersion": {
            "Description": "NMAP version to install, default is 1.18.9",
            "Type": "String",
            "Default": "1.18.9"
        },
        "NumberOfNodes": {
            "Description": "Number of Contrail+microK8s clusters to deploy in the auto scaling group",
            "Type": "String",
            "Default": "1"
         },
        "DebugLogs": {
            "Description": "if true we will enable SYS_DEBUG in the contrail cni",
            "Type": "String",
            "Default": "false"
        },
        "ExternaldnsEnabled": {
            "Description": "true if you want to deploy external DNS into AWS with a test app",
            "Type": "String",
            "Default": "true"
        },
        "ExternaldnsCreateZone": {
            "Description": "true if you want the stack to create the zone",
            "Type": "String",
            "Default": "true"
        },
        "ExternaldnsDomainFilter": {
            "Description": "domain for the external dns to monitor",
            "Type": "String",
            "Default": "incubator.dev.int.foobarservices.com"
        },
        "ExternaldnsZoneID": {
            "Description": "if using an existing domain enter the hosted zone ID here",
            "Type": "String",
            "Default": "Z09733143J0NHZEXWD6B"
        }
    },
    "Resources": {
        "InfraStack": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                 "TemplateURL" : "https://wraithdeployer.s3-eu-west-3.amazonaws.com/wraith-infra.json",
                 "Parameters": {
                    "AvailabilityZone1": {
                        "Ref": "AvailabilityZone1"
                    },
                    "AvailabilityZone2": {
                        "Ref": "AvailabilityZone2"
                    },
                    "AvailabilityZone3": {
                        "Ref": "AvailabilityZone3"
                    },
                    "VPCCIDR1": {
                        "Ref": "VPCCIDR1"
                    },
                    "PublicSubnetCIDR1": {
                        "Ref": "PublicSubnetCIDR1"
                    },
                    "PrivateSubnetCIDR1": {
                        "Ref": "PrivateSubnetCIDR1"
                    },
                    "PrivateSubnetCIDR2": {
                        "Ref": "PrivateSubnetCIDR2"
                    },
                    "PrivateSubnetCIDR3": {
                        "Ref": "PrivateSubnetCIDR3"
                    },
                    "SiteName": {
                        "Ref": "SiteName"
                    },
                    "VPCDOMAIN": {
                        "Ref": "VPCDOMAIN"
                    }
                }
            }
        },
        "NodeStack": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                 "TemplateURL" : "https://wraithdeployer.s3-eu-west-3.amazonaws.com/wraith-nmap-nodes.json",
                 "Parameters": {
                    "AvailabilityZone1": {
                        "Ref": "AvailabilityZone1"
                    },
                    "BastionInstanceType": {
                        "Ref": "BastionInstanceType"
                    },
                    "WraithNodeInstanceType": {
                        "Ref": "WraithNodeInstanceType"
                    },
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "ContrailBastionPrivateSNGatewayIP": {
                        "Ref": "ContrailBastionPrivateSNGatewayIP"
                    },
                    "DeployContrailBastion": {
                        "Ref": "DeployContrailBastion"
                    },
                    "ContrailBastionAZ1PublicIP": {
                        "Ref": "ContrailBastionAZ1PublicIP"
                    },
                    "ContrailBastionAZ1PrivateIP": {
                        "Ref": "ContrailBastionAZ1PrivateIP"
                    },
                    "WraithAZ1PrivateIP": {
                        "Ref": "WraithAZ1PrivateIP"
                    },
                    "UserLocation": {
                        "Ref": "UserLocation"
                    },
                    "SiteName": {
                        "Ref": "SiteName"
                    },
                    "idVPC": {
                        "Fn::GetAtt": [ "InfraStack", "Outputs.idVPC" ]
                    },
                    "idPublicSubnet1": {
                        "Fn::GetAtt": [ "InfraStack", "Outputs.idPublicSubnet1" ]
                    },
                    "idPrivateSubnet1": {
                        "Fn::GetAtt": [ "InfraStack", "Outputs.idPrivateSubnet1" ]
                    },
                    "NMAPVersion": {
                        "Ref": "NMAPVersion"
                    },
                    "NumberOfNodes": {
                        "Ref": "NumberOfNodes"
                    },
                    "DebugLogs": {
                        "Ref": "DebugLogs"
                    },
                    "ExternaldnsEnabled": {
                        "Ref": "ExternaldnsEnabled"
                    },
                    "ExternaldnsCreateZone": {
                        "Ref": "ExternaldnsCreateZone"
                    },
                    "ExternaldnsDomainFilter": {
                        "Ref": "ExternaldnsDomainFilter"
                    },
                    "ExternaldnsZoneID": {
                        "Ref": "ExternaldnsZoneID"
                    }
                }
            }
        }
    },
    "Outputs": {
        "ContrailBastionWebUI": {
            "Description": "Contrail Bastion Web UI, please give it a few minutes to build",
            "Value":  { "Fn::Join": [ "", [ "https://", { "Fn::GetAtt": [ "NodeStack", "Outputs.IPAddress1" ] }, ":9091" ] ] }
        },
        "ContrailBastionAZ1PublicIP": {
            "Description": "Contrail Bastion Public IP",
            "Value": {
                "Fn::GetAtt": [ "NodeStack", "Outputs.IPAddress1" ] 
            }
        },
        "SSHtoContrailBastion": {
            "Description": "SSH to contrail bastion",
            "Value": { "Fn::Join": [ "", [ "   ssh -i [your ContrailKey1 private key file] ubuntu@", { "Fn::GetAtt": [ "NodeStack", "Outputs.IPAddress1" ] }, "" ] ] }
        },
        "EnableAccessToWraithK8SNode": {
            "Description": "enable ssh and contrail ui access to any wraith scaling group node via the Bastion",
            "Value": { "Fn::Join": [ "", [ "   ssh -i [your ContrailKey1 private key file] ubuntu@", { "Fn::GetAtt": [ "NodeStack", "Outputs.IPAddress1" ] }, " sudo /usr/bin/add-nat.sh -n [node ip address] " ] ] }
        },
        "SSHToWraithNode": {
            "Description": "ssh to any wraith scaling group node via the Bastion",
            "Value": { "Fn::Join": [ "", [ "   ssh -i [your ContrailKey1 private key file] ubuntu@", { "Fn::GetAtt": [ "NodeStack", "Outputs.IPAddress1" ] }, " -p 222 " ] ] }
        },
        "ContrailUIAccessWraithNode": {
            "Description": "Contrail web UI on the wraith node via Contrail Bastion",
            "Value": { "Fn::Join": [ "", [ "https://", { "Fn::GetAtt": [ "NodeStack", "Outputs.IPAddress1" ] }, ":8143 " ] ] }
        },
        "Note1": {
            "Description": "NA",
            "Value": "Note: if you rerun add-nat.sh to access a different node you will have to clear your browser cache" 
        }
    }
}
